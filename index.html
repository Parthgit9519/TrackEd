<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover"
    />
    <title>TrackED — Attendance Demo</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <!-- Font Awesome (icons) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Tailwind theme extension -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#1e40af",
              accent: "#6366f1",
              success: "#10b981",
              danger: "#ef4444",
            },
          },
        },
      };
    </script>

    <style>
      /* Tiny extras */
      .animate-fade {
        animation: fadeIn 0.35s ease-out both;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      #cameraVideo {
        background: #000;
        border-radius: 0.5rem;
      }
      #toast.show {
        display: block;
        opacity: 0;
        animation: toastIn 0.28s forwards;
      }
      @keyframes toastIn {
        to {
          opacity: 1;
          transform: translateY(-4px);
        }
      }
      /* keep table headers sticky for wide lists */
      .sticky-head thead th {
        position: sticky;
        top: 0;
        background: white;
        z-index: 2;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50">
    <!-- Auth modal (demo) -->
    <div
      id="authModal"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"
    >
      <div class="bg-white rounded-2xl w-full max-w-md p-6 relative">
        <h2 class="text-2xl font-semibold text-primary mb-3">
          TrackED — Sign in / Sign up (Demo)
        </h2>
        <div class="flex gap-2 mb-4 bg-gray-100 rounded p-1">
          <button
            id="loginTab"
            class="flex-1 rounded bg-primary text-white py-2"
          >
            Sign In
          </button>
          <button id="registerTab" class="flex-1 rounded text-gray-600 py-2">
            Sign Up
          </button>
        </div>

        <form id="loginForm" class="space-y-3">
          <input
            id="loginEmail"
            class="w-full border px-3 py-2 rounded"
            placeholder="email"
            value="student@demo"
          />
          <div class="flex gap-2">
            <input
              id="loginPassword"
              type="password"
              class="flex-1 border px-3 py-2 rounded"
              placeholder="password"
              value="password"
            />
            <select id="loginRole" class="border px-2 py-2 rounded">
              <option value="student">Student</option>
              <option value="teacher">Teacher</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <button
            type="submit"
            class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-2 rounded"
          >
            Sign in
          </button>
        </form>

        <form id="registerForm" class="hidden space-y-3">
          <input
            id="regName"
            class="w-full border px-3 py-2 rounded"
            placeholder="Full name"
          />
          <input
            id="regEmail"
            class="w-full border px-3 py-2 rounded"
            placeholder="email"
          />
          <div class="flex gap-2">
            <select id="regRole" class="border px-2 py-2 rounded">
              <option value="student">Student</option>
              <option value="teacher">Teacher</option>
              <option value="admin">Admin</option>
            </select>
            <input
              id="regPass"
              type="password"
              class="flex-1 border px-3 py-2 rounded"
              placeholder="password"
            />
          </div>
          <button
            id="registerBtn"
            class="w-full bg-primary text-white py-2 rounded"
          >
            Create account
          </button>
        </form>

        <button id="closeAuth" class="absolute top-3 right-3 text-gray-400">
          <i class="fa fa-times"></i>
        </button>
      </div>
    </div>

    <!-- App shell -->
    <div class="flex min-h-screen">
      <!-- sidebar -->
      <aside id="sidebar" class="w-72 bg-white border-r p-4 hidden md:block">
        <div class="flex items-center gap-2 mb-6">
          <div
            class="w-10 h-10 rounded bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center text-white"
          >
            <i class="fa fa-check"></i>
          </div>
          <div>
            <div class="font-semibold">TrackED</div>
            <div class="text-xs text-gray-500">Attendance Management</div>
          </div>
        </div>

        <div class="mb-4">
          <label class="text-xs text-gray-500">Role (preview)</label>
          <select
            id="roleSwitcher"
            class="w-full mt-2 border px-2 py-2 rounded"
          >
            <option value="student">Student</option>
            <option value="teacher">Teacher</option>
            <option value="admin">Admin</option>
          </select>
        </div>

        <nav class="space-y-2 text-sm">
          <a
            class="nav-link block p-3 rounded hover:bg-gray-50"
            data-target="dashboard"
            >Dashboard</a
          >
          <a
            class="nav-link block p-3 rounded hover:bg-gray-50"
            data-target="attendance"
            >Attendance</a
          >
          <a
            class="nav-link block p-3 rounded hover:bg-gray-50"
            data-target="students"
            >Students</a
          >
          <a
            class="nav-link block p-3 rounded hover:bg-gray-50"
            data-target="teachers"
            >Teachers</a
          >
          <a
            class="nav-link block p-3 rounded hover:bg-gray-50"
            data-target="reports"
            >Reports</a
          >
        </nav>
      </aside>

      <!-- mobile top bar -->
      <div class="w-full">
        <header
          class="flex items-center justify-between p-3 border-b bg-white md:hidden"
        >
          <div class="flex items-center gap-2">
            <button id="mobileMenuBtn" class="p-2 border rounded">
              <i class="fa fa-bars"></i>
            </button>
            <div class="font-semibold">TrackED</div>
          </div>
          <div class="flex items-center gap-3">
            <div id="mobileRoleLabel" class="text-sm text-gray-600">
              Student
            </div>
            <button id="openAuth" class="p-2 border rounded">
              <i class="fa fa-user"></i>
            </button>
          </div>
        </header>

        <!-- content -->
        <main class="p-4">
          <div class="mb-4">
            <h1 id="pageTitle" class="text-xl font-semibold">Dashboard</h1>
            <p id="pageSubtitle" class="text-sm text-gray-500">
              Welcome to TrackED
            </p>
          </div>

          <!-- primary mount -->
          <div id="content" class="space-y-6"></div>
        </main>
      </div>
    </div>

    <!-- small utilities -->
    <div
      id="toast"
      class="fixed bottom-6 right-6 hidden bg-black text-white px-4 py-2 rounded"
    ></div>

    <script>
      /* -------------------------
         Application State & Mock Data
         ------------------------- */
      const state = {
        currentRole: localStorage.getItem('tracked_role') || 'student',
        currentSection: 'dashboard',
        students: JSON.parse(localStorage.getItem('tracked_students')) || [
          { id:'S001', name:'Aarav Patel', cls:'10A' },
          { id:'S002', name:'Meera Shah', cls:'10A' },
          { id:'S003', name:'Rohan Kumar', cls:'10B' }
        ],
        teachers: JSON.parse(localStorage.getItem('tracked_teachers')) || [
          { id:'T001', name:'Mr. Gupta', subject:'Mathematics' },
          { id:'T002', name:'Ms. Verma', subject:'Physics' }
        ],
        attendance: JSON.parse(localStorage.getItem('tracked_attendance')) || [
          { id:'R001', studentId:'S001', studentName:'Aarav Patel', status:'Present', role:'student', location:null, timestamp:'2025-09-18T08:30:00Z' },
          { id:'R002', studentId:'S002', studentName:'Meera Shah', status:'Absent', role:'student', location:null, timestamp:'2025-09-17T09:00:00Z' }
        ],
        charts: {}
      };

      function saveAll(){
        localStorage.setItem('tracked_students', JSON.stringify(state.students));
        localStorage.setItem('tracked_teachers', JSON.stringify(state.teachers));
        localStorage.setItem('tracked_attendance', JSON.stringify(state.attendance));
        localStorage.setItem('tracked_role', state.currentRole);
      }

      /* -------------------------
         Small helpers
         ------------------------- */
      const qs = (s, root=document) => root.querySelector(s);
      const qsa = (s, root=document) => Array.from(root.querySelectorAll(s));
      const uid = (p='id') => p + Math.random().toString(36).slice(2,9);
      function toast(msg, t=2200){
        const el = qs('#toast');
        el.textContent = msg;
        el.classList.remove('hidden');
        el.classList.add('show');
        setTimeout(()=>{ el.classList.add('hidden'); el.classList.remove('show'); }, t);
      }

      /* -------------------------
         Charts utilities (Chart.js)
         ------------------------- */
      function createDoughnut(ctx, labels, data){
        if (!ctx) return null;
        if (ctx._chart) ctx._chart.destroy();
        ctx._chart = new Chart(ctx, {
          type: 'doughnut',
          data: { labels, datasets: [{ data, backgroundColor:['#10b981','#ef4444','#f59e0b'] }]},
          options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}, cutout:'60%' }
        });
        return ctx._chart;
      }
      function createBar(ctx, labels, data){
        if (!ctx) return null;
        if (ctx._chart) ctx._chart.destroy();
        ctx._chart = new Chart(ctx, {
          type:'bar',
          data:{ labels, datasets:[{ label:'Attendance %', data, borderRadius:6 }]},
          options:{ responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true, max:100}}, plugins:{legend:{display:false}}}
        });
        return ctx._chart;
      }
      function createLine(ctx, labels, data){
        if (!ctx) return null;
        if (ctx._chart) ctx._chart.destroy();
        ctx._chart = new Chart(ctx, {
          type:'line',
          data:{ labels, datasets:[{ label:'Trend', data, tension:0.35, fill:true, pointRadius:2 }]},
          options:{ responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true, max:100}}, plugins:{legend:{display:false}}}
        });
        return ctx._chart;
      }

      /* -------------------------
         Renderer: per-role dashboards
         ------------------------- */
      function render(){
        // page title
        qs('#pageTitle').textContent = `${capitalize(state.currentRole)} — ${capitalize(state.currentSection)}`;
        qs('#pageSubtitle').textContent = `Role: ${capitalize(state.currentRole)} • Section: ${capitalize(state.currentSection)}`;

        // inject content
        const mount = qs('#content');
        if (!mount) return;
        let html = '';

        // STUDENT Dashboard (distinct)
        if (state.currentRole === 'student' && state.currentSection === 'dashboard') {
          html = studentDashboard();
        }
        // TEACHER Dashboard (distinct)
        else if (state.currentRole === 'teacher' && state.currentSection === 'dashboard') {
          html = teacherDashboard();
        }
        // ADMIN Dashboard (distinct)
        else if (state.currentRole === 'admin' && state.currentSection === 'dashboard') {
          html = adminDashboard();
        }
        // Generic: attendance/students/teachers/reports routes render simpler pages (reusable)
        else {
          if (state.currentSection === 'attendance') html = attendancePage();
          else if (state.currentSection === 'students') html = studentsPage();
          else if (state.currentSection === 'teachers') html = teachersPage();
          else if (state.currentSection === 'reports') html = reportsPage();
          else html = dashboardFallback();
        }

        mount.innerHTML = html;
        mount.classList.add('animate-fade');

        // after DOM insertion, wire events & charts
        wireUpAfterRender();
      }

      /* -------------------------
         UI fragments
         ------------------------- */

      function studentDashboard(){
        // Student dashboard with top camera and live location
        return `
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- left cards -->
            <div class="space-y-4">
              <div class="bg-white p-4 rounded shadow">
                <div class="text-sm text-gray-500">Attendance This Week</div>
                <div class="text-2xl font-semibold mt-2">${randomBetween(80,97)}%</div>
                <div class="text-xs text-gray-400 mt-1">Keep it up! 🎯</div>
              </div>
              <div class="bg-white p-4 rounded shadow">
                <div class="text-sm text-gray-500">Upcoming Classes</div>
                <ul class="mt-2 text-sm space-y-2">
                  <li>09:00 — Math (Room 204)</li>
                  <li>11:00 — Physics (Lab 3)</li>
                </ul>
              </div>
            </div>

            <!-- center: camera + location -->
            <div class="bg-white p-4 rounded shadow flex flex-col items-center">
              <div class="w-full max-w-xl">
                <h3 class="font-semibold mb-2">Live Camera — Mark Attendance</h3>
                <video id="studentVideo" autoplay playsinline class="w-full rounded aspect-video bg-black"></video>
                <div class="flex gap-2 mt-3">
                  <select id="studentCameraList" class="border px-2 py-1 rounded flex-1"></select>
                  <button id="studentStartCam" class="px-3 py-1 bg-primary text-white rounded">Start</button>
                  <button id="studentMarkBtn" class="px-3 py-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded">Mark</button>
                </div>

                <div class="flex gap-2 mt-3">
                  <button id="liveLocationBtn" class="px-3 py-1 border rounded flex-1">Get Live Location</button>
                  <div id="liveLocationDisplay" class="px-3 py-1 rounded border text-xs text-gray-600">—</div>
                </div>

                <p class="text-xs text-gray-400 mt-2">Camera + Location require browser permissions and secure context (https / localhost).</p>
              </div>
            </div>

            <!-- right: small attendance breakdown -->
            <div class="bg-white p-4 rounded shadow">
              <h3 class="font-semibold mb-2">Your Recent</h3>
              <div class="h-40">
                <canvas id="studentDoughnut"></canvas>
              </div>
            </div>
          </div>

          <!-- history -->
          <div class="bg-white p-4 rounded shadow mt-4">
            <h3 class="font-semibold mb-2">Attendance History</h3>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm sticky-head">
                <thead>
                  <tr class="text-xs text-gray-500">
                    <th class="text-left p-2">Date</th>
                    <th class="text-left p-2">Subject</th>
                    <th class="text-left p-2">Status</th>
                    <th class="text-left p-2">Location</th>
                    <th class="text-left p-2">Marked</th>
                  </tr>
                </thead>
                <tbody>
                  ${state.attendance.map(a => `
                    <tr>
                      <td class="p-2">${new Date(a.timestamp).toLocaleDateString()}</td>
                      <td class="p-2">${a.studentName || '—'}</td>
                      <td class="p-2">${statusBadge(a.status)}</td>
                      <td class="p-2">${a.location ? `${a.location.latitude.toFixed(3)}, ${a.location.longitude.toFixed(3)}` : '—'}</td>
                      <td class="p-2">${new Date(a.timestamp).toLocaleString()}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      function teacherDashboard(){
        // Teacher dashboard: per-class bar chart + quick marking UI
        return `
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="bg-white p-4 rounded shadow col-span-1">
              <h3 class="font-semibold">Class Controls</h3>
              <div class="mt-3 space-y-2">
                <label class="text-xs text-gray-500">Select Class</label>
                <select id="teacherClassSelect" class="w-full border px-2 py-2 rounded">
                  ${uniqueClasses().map(c => `<option value="${c}">${c}</option>`).join('')}
                </select>

                <div class="mt-2 text-sm">
                  <div class="text-xs text-gray-500">Add roster student</div>
                  <div class="flex gap-2 mt-2">
                    <input id="teacherAddName" class="flex-1 border px-2 py-1 rounded" placeholder="Full name" />
                    <button id="teacherAddStudentBtn" class="px-3 py-1 bg-primary text-white rounded">Add</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-white p-4 rounded shadow col-span-2">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold">Class Attendance</h3>
                <div class="text-xs text-gray-500">Realtime mock</div>
              </div>
              <div class="mt-3 chart-auto">
                <canvas id="teacherBar"></canvas>
              </div>
            </div>
          </div>

          <div class="bg-white p-4 rounded shadow mt-4">
            <h3 class="font-semibold mb-3">Students Roster</h3>
            <div id="teacherRoster" class="space-y-2 max-h-64 overflow-auto">
              ${state.students.map(s => `
                <div class="flex items-center justify-between p-2 border rounded">
                  <div>
                    <div class="font-medium">${s.name}</div>
                    <div class="text-xs text-gray-400">${s.id} • ${s.cls}</div>
                  </div>
                  <div class="flex gap-2">
                    <button data-id="${s.id}" class="teacherPresentBtn px-3 py-1 bg-green-50 text-green-700 rounded">Present</button>
                    <button data-id="${s.id}" class="teacherAbsentBtn px-3 py-1 bg-red-50 text-red-700 rounded">Absent</button>
                    <button data-name="${s.name}" class="teacherAlertBtn px-3 py-1 border rounded text-xs">Alert</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      function adminDashboard(){
        // Admin: multi-chart + reports
        return `
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="bg-white p-4 rounded shadow">
              <h3 class="font-semibold">Overall Snapshot</h3>
              <div class="h-48 mt-3">
                <canvas id="adminDoughnut"></canvas>
              </div>
            </div>

            <div class="bg-white p-4 rounded shadow col-span-2">
              <h3 class="font-semibold">Monthly Trend</h3>
              <div class="h-48 mt-3">
                <canvas id="adminLine"></canvas>
              </div>
            </div>
          </div>

          <div class="bg-white p-4 rounded shadow mt-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold">Reports</h3>
              <div class="flex gap-2">
                <button id="exportCsv" class="px-3 py-1 border rounded">Export CSV</button>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="min-w-full text-sm sticky-head">
                <thead>
                  <tr class="text-xs text-gray-500"><th class="p-2 text-left">Report</th><th class="p-2">Type</th><th class="p-2">Created</th><th class="p-2">Action</th></tr>
                </thead>
                <tbody>
                  <tr><td class="p-2">Monthly - Class 10A</td><td class="p-2">CSV</td><td class="p-2">2025-09-01</td><td class="p-2"><button class="text-primary text-sm">Download</button></td></tr>
                  <tr><td class="p-2">Daily Snapshot - 2025-09-18</td><td class="p-2">PDF</td><td class="p-2">2025-09-18</td><td class="p-2"><button class="text-primary text-sm">Download</button></td></tr>
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      /* generic pages (attendance/students/etc) used for nav routes */
      function attendancePage(){
        return `
          <div class="bg-white p-4 rounded shadow">
            <h3 class="font-semibold">All Attendance Records</h3>
            <div class="mt-3 overflow-x-auto">
              <table class="min-w-full text-sm sticky-head">
                <thead><tr class="text-xs text-gray-500"><th class="p-2">ID</th><th class="p-2">Student</th><th class="p-2">Status</th><th class="p-2">Timestamp</th></tr></thead>
                <tbody>
                  ${state.attendance.map(a => `<tr><td class="p-2">${a.id}</td><td class="p-2">${a.studentName}</td><td class="p-2">${a.status}</td><td class="p-2">${new Date(a.timestamp).toLocaleString()}</td></tr>`).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
      function studentsPage(){
        return `
          <div class="bg-white p-4 rounded shadow">
            <h3 class="font-semibold">Students</h3>
            <div class="mt-3">
              <div class="flex gap-2 mb-3">
                <input id="newStudentName" class="border px-2 py-1 rounded flex-1" placeholder="Student name" />
                <select id="newStudentClass" class="border px-2 py-1 rounded"><option>10A</option><option>10B</option><option>11A</option></select>
                <button id="addStudent" class="px-3 py-1 bg-primary text-white rounded">Add</button>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full text-sm sticky-head">
                  <thead><tr class="text-xs text-gray-500"><th class="p-2">ID</th><th class="p-2">Name</th><th class="p-2">Class</th><th class="p-2">Action</th></tr></thead>
                  <tbody>
                    ${state.students.map(s => `<tr><td class="p-2">${s.id}</td><td class="p-2">${s.name}</td><td class="p-2">${s.cls}</td><td class="p-2"><button data-id="${s.id}" class="editStudent text-sm text-primary">Edit</button></td></tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
      }
      function teachersPage(){
        return `
          <div class="bg-white p-4 rounded shadow">
            <h3 class="font-semibold">Teachers</h3>
            <div class="mt-3 overflow-x-auto">
              <table class="min-w-full text-sm sticky-head">
                <thead><tr class="text-xs text-gray-500"><th class="p-2">ID</th><th class="p-2">Name</th><th class="p-2">Subject</th></tr></thead>
                <tbody>
                  ${state.teachers.map(t=>`<tr><td class="p-2">${t.id}</td><td class="p-2">${t.name}</td><td class="p-2">${t.subject}</td></tr>`).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
      function reportsPage(){
        return `
          <div class="bg-white p-4 rounded shadow">
            <h3 class="font-semibold">Reports</h3>
            <p class="text-sm text-gray-500 mt-2">Export CSV or PDF (demo client-side CSV available)</p>
            <div class="mt-3">
              <button id="exportCsvGlobal" class="px-3 py-1 border rounded">Export attendance CSV</button>
            </div>
          </div>
        `;
      }
      function dashboardFallback(){ return `<div class="bg-white p-4 rounded shadow">Default content</div>`; }

      /* -------------------------
         After-insert event wiring
         ------------------------- */
      async function wireUpAfterRender(){
        // Update mobile role label
        qs('#mobileRoleLabel').textContent = capitalize(state.currentRole);

        // STUDENT UI wiring
        const studentVideo = qs('#studentVideo');
        const studentCamList = qs('#studentCameraList');
        const studentStartCam = qs('#studentStartCam');
        const studentMarkBtn = qs('#studentMarkBtn');
        const liveLocationBtn = qs('#liveLocationBtn');
        const liveLocationDisplay = qs('#liveLocationDisplay');

        // populate camera devices
        if (studentCamList) {
          try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cams = devices.filter(d=>d.kind === 'videoinput');
            studentCamList.innerHTML = cams.map(c => `<option value="${c.deviceId}">${c.label || 'Camera'}</option>`).join('') || '<option>Default</option>';
          } catch(e){
            studentCamList.innerHTML = '<option>Default</option>';
          }
        }

        let studentStream = null;
        if (studentStartCam) studentStartCam.onclick = async () => {
          try {
            if (studentStream) studentStream.getTracks().forEach(t=>t.stop());
            const deviceId = studentCamList?.value;
            studentStream = await navigator.mediaDevices.getUserMedia({ video: deviceId ? { deviceId: { exact: deviceId } } : true, audio:false });
            studentVideo.srcObject = studentStream;
            toast('Camera started (allow permissions)');
          } catch(err){
            console.error(err);
            toast('Camera permission denied or not available');
          }
        };

        // Live location
        if (liveLocationBtn) {
          liveLocationBtn.onclick = async () => {
            if (!navigator.geolocation) { toast('Geolocation API not supported'); return; }
            liveLocationDisplay.textContent = 'Locating...';
            navigator.geolocation.getCurrentPosition(pos => {
              const lat = pos.coords.latitude, lon = pos.coords.longitude;
              liveLocationDisplay.textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
              toast('Location acquired');
            }, err => {
              console.warn(err);
              liveLocationDisplay.textContent = 'Denied / unavailable';
              toast('Location unavailable or denied');
            }, { enableHighAccuracy:true, timeout:10000 });
          };
        }

        // Mark attendance button: capture snapshot + location and store record
        if (studentMarkBtn) {
          studentMarkBtn.onclick = async () => {
            // snapshot not used beyond UX, capture for future
            if (studentVideo && studentVideo.srcObject) {
              const v = studentVideo;
              const canvas = document.createElement('canvas');
              canvas.width = v.videoWidth || 640;
              canvas.height = v.videoHeight || 360;
              canvas.getContext('2d').drawImage(v, 0, 0, canvas.width, canvas.height);
              // optional: convert to dataURL = canvas.toDataURL()
            }
            // get location
            let location = null;
            try{
              location = await new Promise((res, rej) => {
                navigator.geolocation.getCurrentPosition(p => res({ latitude: p.coords.latitude, longitude: p.coords.longitude }), e => res(null), {timeout:8000});
              });
            }catch(e){ location = null; }

            const record = {
              id: uid('R'),
              studentId: 'S001',
              studentName: 'You (Demo)',
              status: 'Present',
              role: 'student',
              location,
              timestamp: new Date().toISOString()
            };
            state.attendance.unshift(record);
            saveAll();
            toast('Attendance marked ✓');
            render(); // re-render to refresh history & charts
          };
        }

        // STUDENT CHART
        const sd = qs('#studentDoughnut');
        if (sd) {
          const present = state.attendance.filter(a=>a.status==='Present').length;
          const absent = state.attendance.filter(a=>a.status==='Absent').length;
          createDoughnut(sd, ['Present','Absent'], [present, absent]);
        }

        /* TEACHER UI wiring */
        const teacherClassSelect = qs('#teacherClassSelect');
        if (teacherClassSelect) {
          teacherClassSelect.onchange = () => {
            updateTeacherBar();
          };
          // Add student by teacher
          const teacherAddBtn = qs('#teacherAddStudentBtn');
          if (teacherAddBtn) teacherAddBtn.onclick = () => {
            const name = qs('#teacherAddName').value.trim();
            const cls = teacherClassSelect.value || uniqueClasses()[0] || '10A';
            if (!name) { toast('Enter student name'); return; }
            state.students.push({ id: uid('S'), name, cls });
            saveAll();
            toast('Student added');
            render();
          };
        }

        // teacher present/absent buttons
        qsa('.teacherPresentBtn').forEach(btn => btn.onclick = () => {
          const id = btn.dataset.id;
          const s = state.students.find(x=>x.id===id);
          if (!s) return;
          state.attendance.unshift({ id:uid('R'), studentId:id, studentName:s.name, status:'Present', role:'teacher', location:null, timestamp:new Date().toISOString() });
          saveAll();
          toast(`${s.name} marked Present`);
          render();
        });
        qsa('.teacherAbsentBtn').forEach(btn => btn.onclick = () => {
          const id = btn.dataset.id;
          const s = state.students.find(x=>x.id===id);
          if (!s) return;
          state.attendance.unshift({ id:uid('R'), studentId:id, studentName:s.name, status:'Absent', role:'teacher', location:null, timestamp:new Date().toISOString() });
          saveAll();
          toast(`${s.name} marked Absent`);
          render();
        });
        qsa('.teacherAlertBtn').forEach(btn => btn.onclick = async () => {
          const name = btn.dataset.name;
          if ("Notification" in window && Notification.permission === "granted") new Notification('TrackED Alert', { body: `Alert sent to ${name} (demo)` });
          else if ("Notification" in window && Notification.permission !== "denied") {
            const p = await Notification.requestPermission();
            if (p === 'granted') new Notification('TrackED Alert', { body: `Alert sent to ${name} (demo)` });
            else alert(`Alert (demo) to ${name}`);
          } else alert(`Alert (demo) to ${name}`);
        });

        // teacher bar chart update
        function updateTeacherBar(){
          const canvas = qs('#teacherBar');
          if (!canvas) return;
          const selClass = qs('#teacherClassSelect')?.value || uniqueClasses()[0];
          // labels: classes
          const classes = uniqueClasses();
          const data = classes.map(cls => {
            // simple %: present marked / total marked for class
            const ids = state.students.filter(s=>s.cls===cls).map(s=>s.id);
            const marked = state.attendance.filter(a=>ids.includes(a.studentId));
            if (marked.length === 0) return randomBetween(75,95);
            const p = Math.round((marked.filter(m=>m.status==='Present').length / marked.length) * 100);
            return p;
          });
          createBar(canvas, classes, data);
        }
        updateTeacherBar(); // initial

        /* ADMIN CHARTS and actions */
        const adminD = qs('#adminDoughnut');
        const adminL = qs('#adminLine');
        if (adminD) {
          const pres = state.attendance.filter(a=>a.status==='Present').length;
          const abs = state.attendance.filter(a=>a.status==='Absent').length;
          createDoughnut(adminD, ['Present','Absent'], [pres, abs]);
        }
        if (adminL) {
          const months = ['Jan','Feb','Mar','Apr','May','Jun'];
          const data = months.map((m,i) => randomBetween(80,95));
          createLine(adminL, months, data);
        }

        // Add student in generic students page
        const addStudentBtn = qs('#addStudent');
        if (addStudentBtn) addStudentBtn.onclick = () => {
          const n = qs('#newStudentName').value.trim();
          const c = qs('#newStudentClass').value;
          if (!n) { toast('Enter name'); return; }
          state.students.push({ id: uid('S'), name:n, cls:c });
          saveAll();
          toast('Student added');
          render();
        };

        // CSV export (admin)
        const exportCsvBtn = qs('#exportCsv') || qs('#exportCsvGlobal') || qs('#exportCsvGlobal');
        if (exportCsvBtn) exportCsvBtn.onclick = () => {
          const rows = [['id','studentName','status','timestamp','lat','lon']];
          state.attendance.forEach(r => rows.push([r.id, r.studentName, r.status, r.timestamp, r.location?.latitude || '', r.location?.longitude || '']));
          const csv = rows.map(row => row.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = `attendance_${new Date().toISOString().slice(0,10)}.csv`;
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          toast('CSV exported (client-side)');
        };

        // edit student
        qsa('.editStudent').forEach(btn => btn.onclick = () => {
          const id = btn.dataset.id;
          const s = state.students.find(x=>x.id===id);
          if (!s) return;
          const name = prompt('Edit name', s.name);
          if (name) { s.name = name; saveAll(); render(); }
        });

        // make tables responsive and charts resize on next tick
        setTimeout(()=> window.dispatchEvent(new Event('resize')), 80);
      }

      /* -------------------------
         Wiring: global nav & auth
         ------------------------- */
      function setupGlobal(){
        // nav links
        qsa('.nav-link').forEach(a => a.addEventListener('click', (ev) => {
          ev.preventDefault();
          const target = a.dataset.target;
          state.currentSection = target || 'dashboard';
          render();
          // hide sidebar on mobile if present
          if (window.innerWidth < 768) {
            const sidebar = document.querySelector('aside#sidebar');
            if (sidebar) sidebar.classList.add('hidden');
          }
        }));

        // mobile menu open/close
        qs('#mobileMenuBtn')?.addEventListener('click', ()=> {
          const aside = qs('aside#sidebar');
          if (aside) aside.classList.toggle('hidden');
        });

        // role switcher (desktop)
        qs('#roleSwitcher')?.addEventListener('change', (e) => {
          state.currentRole = e.target.value;
          localStorage.setItem('tracked_role', state.currentRole);
          // default to dashboard on role change
          state.currentSection = 'dashboard';
          render();
        });

        // auth modal interactions
        qs('#loginTab')?.addEventListener('click', ()=> {
          qs('#loginForm').classList.remove('hidden');
          qs('#registerForm').classList.add('hidden');
        });
        qs('#registerTab')?.addEventListener('click', ()=> {
          qs('#loginForm').classList.add('hidden');
          qs('#registerForm').classList.remove('hidden');
        });

        // sign in
        qs('#loginForm')?.addEventListener('submit', (ev) => {
          ev.preventDefault();
          const role = qs('#loginRole')?.value || 'student';
          state.currentRole = role;
          localStorage.setItem('tracked_role', role);
          qs('#authModal')?.classList.add('hidden');
          render();
        });

        // sign up (quick demo)
        qs('#registerBtn')?.addEventListener('click', (ev) => {
          ev.preventDefault();
          const role = qs('#regRole')?.value || 'student';
          state.currentRole = role;
          localStorage.setItem('tracked_role', role);
          qs('#authModal')?.classList.add('hidden');
          toast('Account created (demo)');
          render();
        });

        // open auth on mobile topbar
        qs('#openAuth')?.addEventListener('click', ()=> qs('#authModal')?.classList.remove('hidden'));
        qs('#closeAuth')?.addEventListener('click', ()=> qs('#authModal')?.classList.add('hidden'));

        // close auth if clicking outside modal (optional)
        qs('#authModal')?.addEventListener('click', (e) => {
          if (e.target === qs('#authModal')) qs('#authModal').classList.add('hidden');
        });

        // initial role sync
        const roleSel = qs('#roleSwitcher');
        if (roleSel) roleSel.value = state.currentRole;
      }

      /* -------------------------
         Utilities & small helpers
         ------------------------- */
      function capitalize(s){ return s ? s.charAt(0).toUpperCase()+s.slice(1) : s; }
      function statusBadge(s){ return s === 'Present' ? '<span class="text-green-700 bg-green-50 px-2 py-0.5 rounded text-xs">Present</span>' : '<span class="text-red-700 bg-red-50 px-2 py-0.5 rounded text-xs">Absent</span>'; }
      function uniqueClasses(){ return Array.from(new Set(state.students.map(s=>s.cls || '10A'))); }
      function randomBetween(a,b){ return Math.floor(a + Math.random()*(b-a+1)); }

      /* --------------------
         Boot
         ------------------------- */
      window.addEventListener('load', () => {
        setupGlobal();
        // if no role persisted, show auth modal else hide
        if (!localStorage.getItem('tracked_role')) qs('#authModal')?.classList.remove('hidden');
        else qs('#authModal')?.classList.add('hidden');
        render();
      });
      window.addEventListener('beforeunload', saveAll);
    </script>
  </body>
</html>
